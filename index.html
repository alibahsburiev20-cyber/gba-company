<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Чат-рулетка 5 мин</title>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --gray: #64748b;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .container {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      padding: 32px;
      width: 100%;
      max-width: 480px;
    }
    h1 {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 16px;
      text-align: center;
    }
    #status {
      font-size: 1.1rem;
      font-weight: 600;
      text-align: center;
      margin: 16px 0;
      color: var(--gray);
      min-height: 1.5em;
    }
    #timer {
      font-size: 2.5rem;
      font-weight: bold;
      color: var(--primary);
      text-align: center;
      margin: 12px 0;
      letter-spacing: 2px;
    }
    #chat {
      height: 340px;
      overflow-y: auto;
      background: #f1f5f9;
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
      border: 1px solid #e2e8f0;
    }
    .msg {
      margin: 8px 0;
      padding: 10px 14px;
      border-radius: 18px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .mine { 
      background: var(--primary); 
      color: white; 
      margin-left: auto; 
      border-bottom-right-radius: 4px;
    }
    .his { 
      background: #e2e8f0; 
      margin-right: auto; 
      border-bottom-left-radius: 4px;
    }
    .input-area {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    #input {
      flex: 1;
      padding: 14px;
      border: 1px solid #cbd5e1;
      border-radius: 12px;
      font-size: 1rem;
    }
    button {
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    #send, #start, #next, #stop {
      background: var(--primary);
      color: white;
    }
    button:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-1px); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-group { display: flex; gap: 12px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
  </style>
</head>
<body>

<div class="container">
  <h1>Чат-рулетка · 5 минут</h1>
  <div id="status">Нажми «Начать»</div>
  <div id="timer">05:00</div>
  <div id="chat"></div>

  <div class="input-area">
    <input id="input" placeholder="Напиши сообщение..." disabled>
    <button id="send" disabled>→</button>
  </div>

  <div class="btn-group">
    <button id="start">Начать</button>
    <button id="next" disabled>Следующий</button>
    <button id="stop" disabled>Завершить</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDWvsB0nsBWxQZLZ9ppIaeH4hZK_6DBeDw",
    authDomain: "chatroullet-80ba8.firebaseapp.com",
    databaseURL: "https://chatroullet-80ba8-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "chatroullet-80ba8",
    storageBucket: "chatroullet-80ba8.firebasestorage.app",
    messagingSenderId: "494898766457",
    appId: "1:494898766457:web:356fddf6d48b8730052aa8",
    measurementId: "G-SPB60G3NNQ"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const myId = localStorage.getItem('crId') || 'u-' + Math.random().toString(36).slice(2,10);
  localStorage.setItem('crId', myId);

  let roomId = null, timerId = null;

  const $ = id => document.getElementById(id);
  const status = $('status'), timerEl = $('timer'), chat = $('chat'),
        input = $('input'), send = $('send'), start = $('start'),
        nextBtn = $('next'), stopBtn = $('stop');

  const addMsg = (text, mine) => {
    const div = document.createElement('div');
    div.className = `msg ${mine ? 'mine' : 'his'}`;
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  };

  const updateTimer = sec => {
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    timerEl.textContent = `\( {m.toString().padStart(2,'0')}: \){s.toString().padStart(2,'0')}`;
  };

  const listen = () => onValue(ref(db, `rooms/${roomId}/msgs`), snap => {
    chat.innerHTML = '';
    snap.forEach(c => {
      const m = c.val();
      addMsg(m.text, m.from === myId);
    });
  });

  start.onclick = async () => {
    status.textContent = 'Поиск собеседника...';
    start.disabled = nextBtn.disabled = stopBtn.disabled = input.disabled = send.disabled = true;

    await set(ref(db, `waiting/${myId}`), serverTimestamp());

    onValue(ref(db, 'waiting'), async snap => {
      if (roomId || !snap.exists()) return;
      const ids = Object.keys(snap.val() || {});
      if (ids.length < 2 || !ids.includes(myId)) return;

      const p = ids.find(id => id !== myId);
      roomId = [myId, p].sort().join('_');

      await Promise.all([
        remove(ref(db, `waiting/${myId}`)),
        remove(ref(db, `waiting/${p}`)),
        set(ref(db, `rooms/${roomId}`), { start: serverTimestamp(), msgs: [] })
      ]);

      status.textContent = 'Собеседник найден!';
      input.disabled = send.disabled = false;
      nextBtn.disabled = stopBtn.disabled = false;
      listen();

      let sec = 300;
      updateTimer(sec);
      timerId = setInterval(() => {
        sec--;
        updateTimer(sec);
        if (sec <= 0) nextBtn.click();
      }, 1000);
    });
  };

  send.onclick = () => {
    const t = input.value.trim();
    if (t && roomId) {
      push(ref(db, `rooms/${roomId}/msgs`), { from: myId, text: t, t: serverTimestamp() });
      input.value = '';
    }
  };

  input.onkeypress = e => e.key === 'Enter' && send.click();

  nextBtn.onclick = async () => {
    clearInterval(timerId);
    if (roomId) await remove(ref(db, `rooms/${roomId}`));
    roomId = null;
    chat.innerHTML = '';
    status.textContent = 'Поиск нового собеседника...';
    updateTimer(300);
    input.disabled = send.disabled = nextBtn.disabled = true;
    start.disabled = false;
    start.click();
  };

  stopBtn.onclick = async () => {
    clearInterval(timerId);
    if (roomId) await remove(ref(db, `rooms/${roomId}`));
    await remove(ref(db, `waiting/${myId}`));
    roomId = null;
    chat.innerHTML = '';
    status.textContent = 'Сессия завершена';
    updateTimer(300);
    input.disabled = send.disabled = nextBtn.disabled = stopBtn.disabled = true;
    start.disabled = false;
  };

  window.onbeforeunload = () => {
    if (roomId) remove(ref(db, `rooms/${roomId}`));
    remove(ref(db, `waiting/${myId}`));
  };
</script>
</body>
</html>
