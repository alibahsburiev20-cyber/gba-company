<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Чат-рулетка 5 мин</title>
  <style>
    :root{--primary:#6366f1;--primary-dark:#4f46e5;--bg:#f8fafc;--card:#ffffff;--text:#1e293b;--gray:#64748b;--red:#ef4444;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:var(--text);min-height:100vh;font-family:system-ui,sans-serif;}
    .container{padding:20px;max-width:100%;margin:0 auto;}
    h1{font-size:1.8rem;color:var(--primary);text-align:center;margin:16px 0;}
    .setup{padding:24px;background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.15);max-width:420px;margin:20px auto;}
    select,input{width:100%;padding:12px;margin:8px 0;border:1px solid #cbd5e1;border-radius:8px;font-size:1rem;}
    .mode-btns{display:flex;gap:10px;margin:16px 0;}
    .mode-btn{flex:1;padding:12px;border:none;border-radius:10px;font-weight:600;cursor:pointer;}
    .mode-btn.active{background:var(--primary);color:white;}
    .mode-btn:not(.active){background:#e2e8f0;color:var(--text);}
    #status{font-size:1.2rem;font-weight:600;text-align:center;margin:16px 0;min-height:1.5em;}
    #timer{font-size:3rem;font-weight:bold;color:var(--primary);text-align:center;margin:8px 0;}
    #chat{height:calc(100vh - 280px);overflow-y:auto;background:#f1f5f9;border-radius:12px;padding:16px;margin:12px 0;border:1px solid #e2e8f0;}
    .msg{margin:8px 0;padding:12px 16px;border-radius:20px;max-width:80%;word-wrap:break-word;}
    .mine{background:var(--primary);color:white;margin-left:auto;border-bottom-right-radius:6px;}
    .his{background:#e2e8f0;margin-right:auto;border-bottom-left-radius:6px;}
    .input-area{display:flex;gap:8px;margin:16px 0;}
    #input{flex:1;padding:14px;border:1px solid #cbd5e1;border-radius:12px;font-size:1.1rem;}
    button{padding:14px 24px;border:none;border-radius:12px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.2s;}
    .btn-primary{background:var(--primary);color:white;}
    .btn-primary:hover:not(:disabled){background:var(--primary-dark);transform:translateY(-1px);}
    .btn-danger{background:var(--red);color:white;}
    button:disabled{opacity:0.5;cursor:not-allowed;}
    .btn-group{display:flex;gap:12px;justify-content:center;margin:16px 0;flex-wrap:wrap;}
    #reportBtn{display:none;}
  </style>
</head>
<body>

<div class="container" id="setup">
  <h1>Чат-рулетка · 5 мин</h1>
  <label>Вы:</label>
  <select id="myGender"><option value="m">Парень</option><option value="f">Девушка</option><option value="o">Другое</option></select>
  <label>Хочу общаться с:</label>
  <select id="wantGender"><option value="any">Любой</option><option value="m">Парень</option><option value="f">Девушка</option><option value="o">Другое</option></select>
  <div class="mode-btns">
    <button class="mode-btn active" data-mode="normal">Обычный</button>
    <button class="mode-btn" data-mode="roleplay">Ролёвка</button>
  </div>
  <button id="ready" class="btn-primary">Готов → войти</button>
</div>

<div id="game" style="display:none;">
  <div id="status">Поиск...</div>
  <div id="timer">05:00</div>
  <div id="chat"></div>
  <div class="input-area">
    <input id="input" placeholder="Сообщение..." disabled>
    <button id="send" class="btn-primary" disabled>→</button>
  </div>
  <div class="btn-group">
    <button id="next" class="btn-primary" disabled>Следующий</button>
    <button id="stop" class="btn-primary" disabled>Завершить</button>
    <button id="reportBtn" class="btn-danger">Пожаловаться</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove, set, serverTimestamp, get } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDWvsB0nsBWxQZLZ9ppIaeH4hZK_6DBeDw",
    authDomain: "chatroullet-80ba8.firebaseapp.com",
    databaseURL: "https://chatroullet-80ba8-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "chatroullet-80ba8",
    storageBucket: "chatroullet-80ba8.firebasestorage.app",
    messagingSenderId: "494898766457",
    appId: "1:494898766457:web:356fddf6d48b8730052aa8",
    measurementId: "G-SPB60G3NNQ"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const myId = localStorage.getItem('crId') || 'u-' + Math.random().toString(36).slice(2,10);
  localStorage.setItem('crId', myId);

  let roomId = null, timerId = null, mode = 'normal', partnerId = null;

  const $ = id => document.getElementById(id);
  const setup = $('setup'), game = $('game'), status = $('status'), timerEl = $('timer'), chat = $('chat'),
        input = $('input'), send = $('send'), ready = $('ready'), nextBtn = $('next'), stopBtn = $('stop'),
        reportBtn = $('reportBtn');

  document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      mode = btn.dataset.mode;
    };
  });

  const addMsg = (text, mine) => {
    const div = document.createElement('div');
    div.className = `msg ${mine ? 'mine' : 'his'}`;
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  };

  const updateTimer = sec => {
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    timerEl.textContent = `\( {m}: \){s.toString().padStart(2,'0')}`;
  };

  const listenRoom = () => {
    onValue(ref(db, `rooms/${roomId}/msgs`), snap => {
      chat.innerHTML = '';
      snap.forEach(c => {
        const m = c.val();
        addMsg(m.text, m.from === myId);
      });
    });

    // Детектим удаление комнаты (собеседник ушёл)
    onValue(ref(db, `rooms/${roomId}`), snap => {
      if (!snap.exists() && roomId) {
        endSession('Собеседник завершил чат');
      }
    });
  };

  const endSession = (msg = 'Сессия завершена') => {
    clearInterval(timerId);
    status.textContent = msg;
    input.disabled = send.disabled = nextBtn.disabled = true;
    reportBtn.style.display = 'inline-block';
    stopBtn.disabled = false;
  };

  ready.onclick = async () => {
    if (await isBlocked()) {
      status.textContent = 'Вы заблокированы на 3 часа';
      return;
    }

    const myG = $('myGender').value;
    const wantG = $('wantGender').value;

    setup.style.display = 'none';
    game.style.display = 'block';
    document.body.style.padding = '0';
    status.textContent = 'Поиск...';
    ready.disabled = true;

    await set(ref(db, `waiting/${myId}`), {
      gender: myG, want: wantG, mode, t: serverTimestamp()
    });

    onValue(ref(db, 'waiting'), async snap => {
      if (roomId || !snap.exists()) return;
      const users = snap.val() || {};
      const candidates = Object.entries(users)
        .filter(([id, u]) => id !== myId && !u.blockedUntil &&
          (u.want === 'any' || u.want === myG) &&
          (wantG === 'any' || wantG === u.gender) &&
          u.mode === mode);

      if (candidates.length < 1) return;

      const [pId] = candidates[0];
      partnerId = pId;
      roomId = [myId, pId].sort().join('_');

      await Promise.all([
        remove(ref(db, `waiting/${myId}`)),
        remove(ref(db, `waiting/${pId}`)),
        set(ref(db, `rooms/${roomId}`), { start: serverTimestamp(), msgs: [], mode })
      ]);

      status.textContent = 'Собеседник найден!';
      input.disabled = send.disabled = false;
      nextBtn.disabled = stopBtn.disabled = false;
      listenRoom();

      let sec = 300;
      updateTimer(sec);
      timerId = setInterval(() => {
        sec--;
        updateTimer(sec);
        if (sec < 0) {
          clearInterval(timerId);
          nextBtn.click();
        }
      }, 1000);
    });
  };

  send.onclick = () => {
    const t = input.value.trim();
    if (t && roomId) {
      push(ref(db, `rooms/${roomId}/msgs`), { from: myId, text: t, t: serverTimestamp() });
      input.value = '';
    }
  };

  input.onkeypress = e => e.key === 'Enter' && send.click();

  nextBtn.onclick = async () => {
    await cleanup();
    status.textContent = 'Поиск нового...';
    updateTimer(300);
    input.disabled = send.disabled = nextBtn.disabled = reportBtn.style.display = 'none';
    ready.disabled = false;
    ready.click();
  };

  stopBtn.onclick = async () => {
    await cleanup();
    setup.style.display = 'block';
    game.style.display = 'none';
    document.body.style.padding = '20px';
    status.textContent = 'Сессия завершена';
    ready.disabled = false;
  };

  reportBtn.onclick = async () => {
    if (!partnerId) return;
    const blockUntil = Date.now() + 3 * 60 * 60 * 1000; // 3 часа
    await set(ref(db, `blocked/${partnerId}`), blockUntil);
    status.textContent = 'Жалоба отправлена. Пользователь заблокирован на 3 часа.';
    reportBtn.disabled = true;
  };

  async function isBlocked() {
    const snap = await get(ref(db, `blocked/${myId}`));
    if (snap.exists()) {
      const until = snap.val();
      if (until > Date.now()) return true;
      await remove(ref(db, `blocked/${myId}`));
    }
    return false;
  }

  async function cleanup() {
    clearInterval(timerId);
    if (roomId) await remove(ref(db, `rooms/${roomId}`));
    roomId = partnerId = null;
    chat.innerHTML = '';
  }

  window.onbeforeunload = () => {
    cleanup();
    remove(ref(db, `waiting/${myId}`));
  };
</script>
</body>
</html>
