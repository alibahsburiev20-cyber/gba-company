<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Чат-рулетка 5 мин</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f0f0f0; text-align: center; }
    #status { font-weight: bold; margin: 10px; color: #444; }
    #chat { height: 320px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: white; margin: 10px auto; max-width: 500px; text-align: left; }
    #input { width: 70%; padding: 10px; font-size: 16px; }
    button { padding: 10px 18px; margin: 5px; font-size: 16px; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>

<h2>Чат-рулетка · 5 минут</h2>
<div id="status">Нажми «Начать»</div>
<div id="chat"></div>
<input id="input" placeholder="Сообщение..." disabled>
<button id="send" disabled>Отправить</button>
<br>
<button id="start">Начать</button>
<button id="next" disabled>Следующий</button>
<button id="stop" disabled>Стоп</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDWvsB0nsBWxQZLZ9ppIaeH4hZK_6DBeDw",
    authDomain: "chatroullet-80ba8.firebaseapp.com",
    databaseURL: "https://chatroullet-80ba8-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "chatroullet-80ba8",
    storageBucket: "chatroullet-80ba8.firebasestorage.app",
    messagingSenderId: "494898766457",
    appId: "1:494898766457:web:356fddf6d48b8730052aa8",
    measurementId: "G-SPB60G3NNQ"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const myId = localStorage.getItem('crId') || 'u-' + Math.random().toString(36).slice(2,10);
  localStorage.setItem('crId', myId);

  let roomId = null, timer = null;

  const $ = id => document.getElementById(id);
  const status = $('status'), chat = $('chat'), input = $('input'),
        send = $('send'), start = $('start'), next = $('next'), stop = $('stop');

  const add = (text, mine) => {
    const d = document.createElement('div');
    d.textContent = text;
    d.style.color = mine ? '#0066cc' : '#333';
    d.style.margin = '4px 0';
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
  };

  const listen = () => onValue(ref(db, `rooms/${roomId}/msgs`), snap => {
    chat.innerHTML = '';
    snap.forEach(c => {
      const m = c.val();
      add(`${m.from === myId ? 'Я' : 'Он'}: ${m.text}`, m.from === myId);
    });
  });

  start.onclick = async () => {
    status.textContent = 'Ожидание...';
    start.disabled = next.disabled = stop.disabled = input.disabled = send.disabled = true;

    await set(ref(db, `waiting/${myId}`), serverTimestamp());

    onValue(ref(db, 'waiting'), async snap => {
      if (roomId || !snap.exists()) return;
      const ids = Object.keys(snap.val() || {});
      if (ids.length < 2 || !ids.includes(myId)) return;

      const p = ids.find(id => id !== myId);
      roomId = [myId, p].sort().join('_');

      await Promise.all([
        remove(ref(db, `waiting/${myId}`)),
        remove(ref(db, `waiting/${p}`)),
        set(ref(db, `rooms/${roomId}`), { start: serverTimestamp(), msgs: [] })
      ]);

      status.textContent = 'Нашли! 5 мин.';
      input.disabled = send.disabled = false;
      next.disabled = stop.disabled = false;
      listen();

      let s = 300;
      timer = setInterval(() => {
        s--;
        status.textContent = `Осталось \( {Math.floor(s/60)}: \){s%60|0 .toString().padStart(2,0)}`;
        if (s <= 0) next.click();
      }, 1000);
    });
  };

  send.onclick = () => {
    const t = input.value.trim();
    if (t && roomId) {
      push(ref(db, `rooms/${roomId}/msgs`), { from: myId, text: t, t: serverTimestamp() });
      input.value = '';
    }
  };

  input.onkeypress = e => e.key === 'Enter' && send.click();

  next.onclick = async () => {
    clearInterval(timer);
    if (roomId) await remove(ref(db, `rooms/${roomId}`));
    roomId = null;
    chat.innerHTML = '';
    status.textContent = 'Ищем...';
    input.disabled = send.disabled = next.disabled = true;
    start.disabled = false;
    start.click();
  };

  stop.onclick = async () => {
    clearInterval(timer);
    if (roomId) await remove(ref(db, `rooms/${roomId}`));
    await remove(ref(db, `waiting/${myId}`));
    roomId = null;
    chat.innerHTML = '';
    status.textContent = 'Завершено';
    input.disabled = send.disabled = next.disabled = stop.disabled = true;
    start.disabled = false;
  };

  window.onbeforeunload = () => {
    if (roomId) remove(ref(db, `rooms/${roomId}`));
    remove(ref(db, `waiting/${myId}`));
  };
</script>
</body>
</html>
