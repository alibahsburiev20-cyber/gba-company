<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Roulette · 5 мин</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f0f17;
      --surface: #171725;
      --primary: #7c3aed;
      --primary-dark: #5b21b6;
      --accent: #a78bfa;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --red: #f87171;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      overflow: hidden;
    }
    #setup, #chat-screen {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      padding: 16px;
      transition: opacity .4s ease, transform .4s ease;
    }
    #setup.active, #chat-screen.active { opacity:1; transform:translateY(0); }
    #setup.inactive, #chat-screen.inactive { opacity:0; transform:translateY(20px); pointer-events:none; }

    .card {
      background: var(--surface);
      border-radius: 20px;
      padding: 32px 28px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      border: 1px solid rgba(124,58,237,0.12);
    }
    h1 {
      font-size: 2.1rem;
      font-weight: 700;
      background: linear-gradient(90deg, var(--accent), var(--primary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-align: center;
      margin-bottom: 28px;
    }
    label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-muted);
      margin: 16px 0 6px;
    }
    select, input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #334155;
      border-radius: 12px;
      background: #1e1e2e;
      color: white;
      font-size: 1rem;
    }
    .mode-toggle {
      display: flex;
      background: #1e1e2e;
      border-radius: 12px;
      padding: 4px;
      margin: 20px 0;
    }
    .mode-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
    }
    .mode-btn.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 14px rgba(124,58,237,0.4);
    }
    .mode-btn:not(.active) { color: var(--text-muted); }

    #status {
      font-size: 1.25rem;
      font-weight: 600;
      text-align: center;
      margin: 16px 0;
      min-height: 1.6em;
    }
    #timer {
      font-size: 4.8rem;
      font-weight: 800;
      letter-spacing: -2px;
      text-align: center;
      margin: 8px 0 24px;
      color: var(--accent);
      text-shadow: 0 0 30px rgba(167,139,250,0.3);
    }
    #messages {
      height: calc(100dvh - 280px);
      overflow-y: auto;
      padding: 16px;
      scrollbar-width: thin;
    }
    .message {
      margin: 10px 0;
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 78%;
      line-height: 1.45;
      word-break: break-word;
    }
    .mine   { background: var(--primary); color: white; margin-left: auto; border-bottom-right-radius: 6px; }
    .theirs { background: #2d2d44; margin-right: auto; border-bottom-left-radius: 6px; }

    .bottom-bar {
      position: sticky;
      bottom: 0;
      background: var(--surface);
      padding: 16px;
      border-top: 1px solid #2d2d44;
      display: flex;
      gap: 12px;
    }
    input { flex: 1; }
    button {
      padding: 0 24px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all .18s;
    }
    .btn-main   { background: var(--primary); color: white; }
    .btn-main:hover   { background: var(--primary-dark); transform: translateY(-1px); }
    .btn-danger { background: var(--red); color: white; }
    button:disabled { opacity: 0.45; transform: none; }

    @media (max-height: 680px) {
      #messages { height: calc(100dvh - 240px); }
      #timer { font-size: 3.8rem; }
    }
  </style>
</head>
<body>

<div id="setup" class="active">
  <div class="card">
    <h1>Roulette</h1>

    <label>Я</label>
    <select id="myGender">
      <option value="m">Парень</option>
      <option value="f">Девушка</option>
      <option value="o">Другое</option>
    </select>

    <label>Хочу собеседника</label>
    <select id="wantGender">
      <option value="any">Любой</option>
      <option value="m">Парень</option>
      <option value="f">Девушка</option>
      <option value="o">Другое</option>
    </select>

    <div class="mode-toggle">
      <button class="mode-btn active" data-mode="chat">Обычный</button>
      <button class="mode-btn" data-mode="rp">Ролевая</button>
    </div>

    <button id="startBtn" class="btn-main" style="width:100%;padding:16px;font-size:1.1rem;margin-top:20px;">
      Начать поиск
    </button>
  </div>
</div>

<div id="chat-screen" class="inactive">
  <div id="status">Поиск...</div>
  <div id="timer">05:00</div>

  <div id="messages"></div>

  <div class="bottom-bar">
    <input id="msgInput" placeholder="Напиши сообщение…" disabled autocomplete="off"/>
    <button id="sendBtn" class="btn-main" disabled>Отправить</button>
  </div>

  <div class="bottom-bar" style="justify-content:center;gap:16px;padding:12px 16px;">
    <button id="nextBtn" class="btn-main" disabled>Следующий</button>
    <button id="stopBtn" class="btn-main" disabled>Завершить</button>
    <button id="reportBtn" class="btn-danger" style="display:none;">Пожаловаться</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove, set, serverTimestamp, get } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

  const config = {
    apiKey: "AIzaSyDWvsB0nsBWxQZLZ9ppIaeH4hZK_6DBeDw",
    authDomain: "chatroullet-80ba8.firebaseapp.com",
    databaseURL: "https://chatroullet-80ba8-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "chatroullet-80ba8",
    storageBucket: "chatroullet-80ba8.firebasestorage.app",
    messagingSenderId: "494898766457",
    appId: "1:494898766457:web:356fddf6d48b8730052aa8",
    measurementId: "G-SPB60G3NNQ"
  };

  const app = initializeApp(config);
  const db = getDatabase(app);

  const myId = localStorage.crId || (localStorage.crId = 'u-'+Math.random().toString(36).slice(2,11));

  let room = null, timer = null, partner = null, mode = 'chat';

  const $ = s => document.getElementById(s);
  const els = {
    setup: $('setup'),
    chatScreen: $('chat-screen'),
    status: $('status'),
    timer: $('timer'),
    messages: $('messages'),
    input: $('msgInput'),
    send: $('sendBtn'),
    start: $('startBtn'),
    next: $('nextBtn'),
    stop: $('stopBtn'),
    report: $('reportBtn')
  };

  document.querySelectorAll('[data-mode]').forEach(el => {
    el.onclick = () => {
      document.querySelectorAll('[data-mode]').forEach(e=>e.classList.remove('active'));
      el.classList.add('active');
      mode = el.dataset.mode;
    };
  });

  const add = (text, mine) => {
    const m = document.createElement('div');
    m.className = `message ${mine?'mine':'theirs'}`;
    m.textContent = text;
    els.messages.appendChild(m);
    els.messages.scrollTop = els.messages.scrollHeight;
  };

  const setTimer = s => {
    const m = (s/60)|0;
    const sec = s%60;
    els.timer.textContent = `\( {m}: \){sec.toString().padStart(2,0)}`;
  };

  const endChat = reason => {
    clearInterval(timer);
    els.status.textContent = reason || 'Чат завершён';
    els.input.disabled = els.send.disabled = els.next.disabled = true;
    els.report.style.display = 'inline-block';
    els.stop.disabled = false;
  };

  const cleanup = async () => {
    clearInterval(timer);
    if (room) await remove(ref(db, `rooms/${room}`));
    room = partner = null;
    els.messages.innerHTML = '';
  };

  els.start.onclick = async () => {
    if (await isBlocked()) {
      els.status.textContent = 'Вы временно заблокированы';
      return;
    }

    const me   = $('myGender').value;
    const want = $('wantGender').value;

    els.setup.classList.remove('active');
    els.setup.classList.add('inactive');
    els.chatScreen.classList.remove('inactive');
    els.chatScreen.classList.add('active');

    els.status.textContent = 'Поиск собеседника…';
    els.start.disabled = true;

    await set(ref(db, `queue/${myId}`), { g:me, w:want, m:mode, ts:serverTimestamp() });

    onValue(ref(db, 'queue'), async snap => {
      if (room || !snap.exists()) return;
      const waiting = snap.val() || {};
      const possible = Object.entries(waiting)
        .filter(([id,v])=> id!==myId && !v.blocked &&
          (v.w==='any'||v.w===me) &&
          (want==='any'||want===v.g) &&
          v.m===mode );

      if (!possible.length) return;

      const [pid] = possible[0];
      partner = pid;
      room = [myId, pid].sort().join('·');

      await Promise.all([
        remove(ref(db, `queue/${myId}`)),
        remove(ref(db, `queue/${pid}`)),
        set(ref(db, `rooms/${room}`), { ts:serverTimestamp(), mode })
      ]);

      els.status.textContent = 'Собеседник найден!';
      els.input.disabled = els.send.disabled = false;
      els.next.disabled = els.stop.disabled = false;

      let left = 300;
      setTimer(left);
      timer = setInterval(() => {
        left--;
        setTimer(left);
        if (left < 0) els.next.click();
      }, 1000);

      onValue(ref(db, `rooms/${room}/msgs`), snap => {
        els.messages.innerHTML = '';
        snap.forEach(c => {
          const msg = c.val();
          add(msg.t, msg.by === myId);
        });
      });

      onValue(ref(db, `rooms/${room}`), s => {
        if (!s.exists() && room) endChat('Собеседник покинул чат');
      });
    });
  };

  els.send.onclick = () => {
    const t = els.input.value.trim();
    if (!t || !room) return;
    push(ref(db, `rooms/${room}/msgs`), { by:myId, t, ts:serverTimestamp() });
    els.input.value = '';
  };

  els.input.onkeypress = e => e.key==='Enter' && els.send.click();

  els.next.onclick = async () => {
    await cleanup();
    els.status.textContent = 'Поиск нового…';
    setTimer(300);
    els.input.disabled = els.send.disabled = els.next.disabled = els.report.style.display = 'none';
    els.start.disabled = false;
    els.start.click();
  };

  els.stop.onclick = async () => {
    await cleanup();
    els.setup.classList.remove('inactive'); els.setup.classList.add('active');
    els.chatScreen.classList.remove('active'); els.chatScreen.classList.add('inactive');
    els.status.textContent = 'Сессия завершена';
    els.start.disabled = false;
  };

  els.report.onclick = async () => {
    if (!partner) return;
    const until = Date.now() + 10800000; // 3 часа
    await set(ref(db, `blocks/${partner}`), until);
    els.status.textContent = 'Жалоба принята · пользователь заблокирован';
    els.report.disabled = true;
  };

  async function isBlocked() {
    const snap = await get(ref(db, `blocks/${myId}`));
    if (!snap.exists()) return false;
    const ts = snap.val();
    if (ts > Date.now()) return true;
    await remove(ref(db, `blocks/${myId}`));
    return false;
  }

  window.onbeforeunload = () => {
    if (room) remove(ref(db, `rooms/${room}`));
    remove(ref(db, `queue/${myId}`));
  };
</script>
</body>
</html>
