<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Roulette ¬∑ 5 –º–∏–Ω</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f0f17;
      --surface: #171725;
      --primary: #7c3aed;
      --primary-dark: #5b21b6;
      --accent: #a78bfa;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --red: #f87171;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { height:100%; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      overflow: hidden;
      touch-action: manipulation;
    }
    #setup, #chat-screen {
      position: fixed;
      inset: 0;
      padding: 16px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: opacity .4s ease, transform .4s ease;
    }
    #setup.active, #chat-screen.active { opacity:1; transform:none; }
    #setup.inactive, #chat-screen.inactive { opacity:0; transform:translateY(16px); pointer-events:none; }

    .card {
      background: var(--surface);
      border-radius: 20px;
      padding: 28px 20px;
      width: 100%;
      max-width: 440px;
      margin: 0 auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      border: 1px solid rgba(124,58,237,0.1);
    }
    h1 {
      font-size: clamp(1.8rem, 8vw, 2.4rem);
      font-weight: 700;
      background: linear-gradient(90deg, var(--accent), var(--primary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-align: center;
      margin-bottom: 24px;
    }
    label { font-size: 0.95rem; color: var(--text-muted); margin: 16px 0 6px; display: block; }
    select, input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #334155;
      border-radius: 12px;
      background: #1e1e2e;
      color: white;
      font-size: 1rem;
    }
    .mode-toggle {
      display: flex;
      background: #1e1e2e;
      border-radius: 12px;
      padding: 4px;
      margin: 20px 0;
    }
    .mode-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
    }
    .mode-btn.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 14px rgba(124,58,237,0.35);
    }
    .mode-btn:not(.active) { color: var(--text-muted); }

    #status {
      font-size: 1.3rem;
      font-weight: 600;
      text-align: center;
      margin: 12px 0 8px;
      min-height: 1.6em;
    }
    #timer {
      font-size: clamp(3.5rem, 18vw, 6rem);
      font-weight: 800;
      letter-spacing: -3px;
      text-align: center;
      color: var(--accent);
      text-shadow: 0 0 40px rgba(167,139,250,0.25);
      margin: 0 0 20px;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 12px;
      scrollbar-width: thin;
      -webkit-overflow-scrolling: touch;
    }
    .message {
      margin: 10px 0;
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 82%;
      line-height: 1.45;
      word-break: break-word;
    }
    .mine   { background: var(--primary); color: white; margin-left: auto; border-bottom-right-radius: 6px; }
    .theirs { background: #2d2d44; margin-right: auto; border-bottom-left-radius: 6px; }

    .bottom-bar {
      background: var(--surface);
      padding: 12px 16px;
      border-top: 1px solid #2d2d44;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    #msgInput { flex: 1; }
    button {
      padding: 0 20px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all .18s;
      min-width: 60px;
    }
    .btn-main   { background: var(--primary); color: white; }
    .btn-main:hover   { background: var(--primary-dark); }
    .btn-danger { background: var(--red); color: white; }
    button:disabled { opacity: 0.4; }

    audio { width: 180px; margin: 4px 0; }

    @media (max-width: 480px) {
      .card { padding: 24px 16px; border-radius: 16px; }
      .bottom-bar { padding: 10px 12px; gap: 6px; }
      button { padding: 0 14px; font-size: 0.95rem; }
    }
  </style>
</head>
<body>

<div id="setup" class="active">
  <div class="card">
    <h1>Roulette</h1>

    <label>–Ø</label>
    <select id="myGender">
      <option value="m">–ü–∞—Ä–µ–Ω—å</option>
      <option value="f">–î–µ–≤—É—à–∫–∞</option>
      <option value="o">–î—Ä—É–≥–æ–µ</option>
    </select>

    <label>–•–æ—á—É —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</label>
    <select id="wantGender">
      <option value="any">–õ—é–±–æ–π</option>
      <option value="m">–ü–∞—Ä–µ–Ω—å</option>
      <option value="f">–î–µ–≤—É—à–∫–∞</option>
      <option value="o">–î—Ä—É–≥–æ–µ</option>
    </select>

    <div class="mode-toggle">
      <button class="mode-btn active" data-mode="chat">–û–±—ã—á–Ω—ã–π</button>
      <button class="mode-btn" data-mode="rp">–†–æ–ª–µ–≤–∞—è</button>
    </div>

    <button id="startBtn" class="btn-main" style="width:100%;padding:16px;font-size:1.1rem;margin-top:20px;">
      –ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫
    </button>
  </div>
</div>

<div id="chat-screen" class="inactive" style="flex-direction:column;">
  <div id="status">–ü–æ–∏—Å–∫...</div>
  <div id="timer">05:00</div>
  <div id="messages"></div>

  <div class="bottom-bar">
    <input id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" disabled autocomplete="off"/>
    <button id="sendBtn" class="btn-main" disabled>‚Üí</button>
    <button id="recordBtn" class="btn-main" disabled>üé§</button>
  </div>

  <div class="bottom-bar" style="justify-content:center;gap:12px;padding:10px 16px;">
    <button id="nextBtn" class="btn-main" disabled>–°–ª–µ–¥—É—é—â–∏–π</button>
    <button id="stopBtn" class="btn-main" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    <button id="reportBtn" class="btn-danger" style="display:none;">–ñ–∞–ª–æ–±–∞</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove, set, serverTimestamp, get } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

  const config = {
    apiKey: "AIzaSyDWvsB0nsBWxQZLZ9ppIaeH4hZK_6DBeDw",
    authDomain: "chatroullet-80ba8.firebaseapp.com",
    databaseURL: "https://chatroullet-80ba8-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "chatroullet-80ba8",
    storageBucket: "chatroullet-80ba8.firebasestorage.app",
    messagingSenderId: "494898766457",
    appId: "1:494898766457:web:356fddf6d48b8730052aa8",
    measurementId: "G-SPB60G3NNQ"
  };

  const app = initializeApp(config);
  const db = getDatabase(app);
  const storage = getStorage(app);

  const myId = localStorage.crId || (localStorage.crId = 'u-'+Math.random().toString(36).slice(2,11));

  let room = null, timer = null, partner = null, mode = 'chat';
  let mediaRecorder = null, audioChunks = [];

  const $ = s => document.getElementById(s);
  const els = {
    setup: $('setup'),
    chatScreen: $('chat-screen'),
    status: $('status'),
    timer: $('timer'),
    messages: $('messages'),
    input: $('msgInput'),
    send: $('sendBtn'),
    start: $('startBtn'),
    next: $('nextBtn'),
    stop: $('stopBtn'),
    report: $('reportBtn'),
    record: $('recordBtn')
  };

  document.querySelectorAll('[data-mode]').forEach(el => {
    el.onclick = () => {
      document.querySelectorAll('[data-mode]').forEach(e=>e.classList.remove('active'));
      el.classList.add('active');
      mode = el.dataset.mode;
    };
  });

  const add = (text, mine) => {
    const m = document.createElement('div');
    m.className = `message ${mine?'mine':'theirs'}`;
    m.textContent = text;
    els.messages.appendChild(m);
    els.messages.scrollTop = els.messages.scrollHeight;
  };

  const setTimer = s => {
    const m = Math.floor(s / 60);
    const sec = s % 60;
    els.timer.textContent = `\( {m}: \){sec.toString().padStart(2,'0')}`;
  };

  const endChat = reason => {
    clearInterval(timer);
    els.status.textContent = reason || '–ß–∞—Ç –∑–∞–≤–µ—Ä—à—ë–Ω';
    els.input.disabled = els.send.disabled = els.next.disabled = els.record.disabled = true;
    els.report.style.display = 'inline-block';
    els.stop.disabled = false;
  };

  const cleanup = async () => {
    clearInterval(timer);
    if (room) await remove(ref(db, `rooms/${room}`));
    room = partner = null;
    els.messages.innerHTML = '';
  };

  // –ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ (–º–∞–∫—Å 5 —Å–µ–∫)
  els.record.onclick = async () => {
    if (!mediaRecorder || mediaRecorder.state === 'inactive') {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

        mediaRecorder.onstop = async () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          if (blob.size < 300) return; // —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ

          const path = `voice/\( {room}/ \){Date.now()}.webm`;
          const storageRef = sRef(storage, path);
          await uploadBytes(storageRef, blob);
          const url = await getDownloadURL(storageRef);

          push(ref(db, `rooms/${room}/msgs`), {
            by: myId,
            type: 'voice',
            url,
            ts: serverTimestamp()
          });

          els.record.textContent = 'üé§';
        };

        mediaRecorder.start();
        els.record.textContent = '‚ñ†';

        setTimeout(() => {
          if (mediaRecorder.state === 'recording') mediaRecorder.stop();
        }, 5000);
      } catch (e) {
        console.error('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', e);
      }
    } else {
      mediaRecorder.stop();
      els.record.textContent = 'üé§';
    }
  };

  els.start.onclick = async () => {
    if (await isBlocked()) {
      els.status.textContent = '–í—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã';
      return;
    }

    const me   = $('myGender').value;
    const want = $('wantGender').value;

    els.setup.classList.remove('active');
    els.setup.classList.add('inactive');
    els.chatScreen.classList.remove('inactive');
    els.chatScreen.classList.add('active');

    els.status.textContent = '–ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞‚Ä¶';
    els.start.disabled = true;

    await set(ref(db, `queue/${myId}`), { g:me, w:want, m:mode, ts:serverTimestamp() });

    onValue(ref(db, 'queue'), async snap => {
      if (room || !snap.exists()) return;
      const waiting = snap.val() || {};
      const possible = Object.entries(waiting)
        .filter(([id,v])=> id!==myId && !v.blocked &&
          (v.w==='any'||v.w===me) &&
          (want==='any'||want===v.g) &&
          v.m===mode );

      if (!possible.length) return;

      const [pid] = possible[0];
      partner = pid;
      room = [myId, pid].sort().join('¬∑');

      await Promise.all([
        remove(ref(db, `queue/${myId}`)),
        remove(ref(db, `queue/${pid}`)),
        set(ref(db, `rooms/${room}`), { ts:serverTimestamp(), mode })
      ]);

      els.status.textContent = '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω!';
      els.input.disabled = els.send.disabled = els.record.disabled = false;
      els.next.disabled = els.stop.disabled = false;

      let left = 300;
      setTimer(left);
      timer = setInterval(() => {
        left--;
        if (left >= 0) setTimer(left);
        if (left <= 0) {
          clearInterval(timer);
          els.next.click();
        }
      }, 1000);

      onValue(ref(db, `rooms/${room}/msgs`), snap => {
        els.messages.innerHTML = '';
        snap.forEach(c => {
          const msg = c.val();
          const div = document.createElement('div');
          div.className = `message ${msg.by === myId ? 'mine' : 'theirs'}`;

          if (msg.type === 'voice') {
            const audio = document.createElement('audio');
            audio.controls = true;
            audio.src = msg.url;
            audio.style.width = '180px';
            div.appendChild(audio);
          } else {
            div.textContent = msg.t || '';
          }

          els.messages.appendChild(div);
          els.messages.scrollTop = els.messages.scrollHeight;
        });
      });

      onValue(ref(db, `rooms/${room}`), s => {
        if (!s.exists() && room) endChat('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤—ã—à–µ–ª');
      });
    });
  };

  els.send.onclick = () => {
    const t = els.input.value.trim();
    if (!t || !room) return;
    push(ref(db, `rooms/${room}/msgs`), { by:myId, t, ts:serverTimestamp() });
    els.input.value = '';
  };

  els.input.onkeypress = e => { if (e.key==='Enter') { e.preventDefault(); els.send.click(); } };

  els.next.onclick = async () => {
    await cleanup();
    els.status.textContent = '–ü–æ–∏—Å–∫ –Ω–æ–≤–æ–≥–æ‚Ä¶';
    setTimer(300);
    els.input.disabled = els.send.disabled = els.record.disabled = els.next.disabled = true;
    els.report.style.display = 'none';
    els.start.disabled = false;
    els.start.click();
  };

  els.stop.onclick = async () => {
    await cleanup();
    els.setup.classList.remove('inactive'); els.setup.classList.add('active');
    els.chatScreen.classList.remove('active'); els.chatScreen.classList.add('inactive');
    els.status.textContent = '–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
    els.start.disabled = false;
  };

  els.report.onclick = async () => {
    if (!partner) return;
    const until = Date.now() + 10800000;
    await set(ref(db, `blocks/${partner}`), until);
    els.status.textContent = '–ñ–∞–ª–æ–±–∞ –ø—Ä–∏–Ω—è—Ç–∞ ¬∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';
    els.report.disabled = true;
  };

  async function isBlocked() {
    const snap = await get(ref(db, `blocks/${myId}`));
    if (!snap.exists()) return false;
    const ts = snap.val();
    if (ts > Date.now()) return true;
    await remove(ref(db, `blocks/${myId}`));
    return false;
  }

  window.onbeforeunload = () => {
    if (room) remove(ref(db, `rooms/${room}`));
    remove(ref(db, `queue/${myId}`));
  };
</script>
</body>
</html>
